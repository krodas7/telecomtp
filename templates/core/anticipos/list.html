{% extends "base.html" %}
{% load custom_filters %}

{% block title %}Anticipos - Sistema de Construcción{% endblock %}

{% block extra_css %}
<!-- VERSIÓN 2025-11-02-00:35 DISEÑO MINIMALISTA EJECUTIVO -->
<style>
    /* ===== HEADER EJECUTIVO ===== */
    .anticipos-hero {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        color: white;
        padding: 2.5rem 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .anticipos-hero-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: white !important;
        letter-spacing: 0.5px;
    }
    
    .anticipos-hero-subtitle {
        font-size: 0.95rem;
        opacity: 0.85;
        margin-bottom: 2rem;
    }
    
    .anticipos-stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        flex-wrap: wrap;
    }
    
    .anticipos-stat {
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(10px);
        padding: 1.2rem 1.8rem;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.25);
        transition: all 0.3s ease;
        min-width: 150px;
    }
    
    .anticipos-stat:hover {
        transform: translateY(-3px);
        background: rgba(255,255,255,0.2);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .anticipos-stat-number {
        display: block;
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 0.3rem;
    }
    
    .anticipos-stat-label {
        font-size: 0.85rem;
        opacity: 0.9;
    }
    
    /* Estilos para notificaciones modernas */
    .modern-notification {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        margin-bottom: 16px;
        overflow: hidden;
        position: relative;
        transform: translateX(100%);
        opacity: 0;
        animation: slideInRight 0.5s ease forwards;
        border-left: 4px solid;
    }
    
    .modern-notification.alert-success {
        border-left-color: #28a745;
    }
    
    .modern-notification.alert-error {
        border-left-color: #dc3545;
    }
    
    .modern-notification.alert-warning {
        border-left-color: #ffc107;
    }
    
    .modern-notification.alert-info {
        border-left-color: #17a2b8;
    }
    
    .notification-content {
        display: flex;
        align-items: flex-start;
        padding: 16px;
        position: relative;
    }
    
    .notification-icon {
        margin-right: 12px;
        font-size: 20px;
        margin-top: 2px;
    }
    
    .modern-notification.alert-success .notification-icon {
        color: #28a745;
    }
    
    .modern-notification.alert-error .notification-icon {
        color: #dc3545;
    }
    
    .modern-notification.alert-warning .notification-icon {
        color: #ffc107;
    }
    
    .modern-notification.alert-info .notification-icon {
        color: #17a2b8;
    }
    
    .notification-text {
        flex: 1;
        font-size: 14px;
        line-height: 1.4;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* Estilos para modals de confirmación */
    .modal-header.bg-danger {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
    }
    
    .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
        border-radius: 15px 15px 0 0;
        border-bottom: none;
    }
    
    .modal-footer {
        border-radius: 0 0 15px 15px;
        border-top: 1px solid #e9ecef;
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
    }
    
    .btn-secondary {
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hero Section -->
    <div class="anticipos-hero">
        <h1 class="anticipos-hero-title">
            <i class="fas fa-hand-holding-usd me-2"></i>
            Gestión de Anticipos
        </h1>
        <p class="anticipos-hero-subtitle">
            Control y administración de anticipos de clientes
        </p>
        
        <!-- Estadísticas Rápidas -->
        <div class="anticipos-stats">
            <div class="anticipos-stat">
                <span class="anticipos-stat-number">{{ total_anticipos }}</span>
                <span class="anticipos-stat-label">Total Anticipos</span>
            </div>
            <div class="anticipos-stat">
                <span class="anticipos-stat-number">{{ anticipos_pendientes }}</span>
                <span class="anticipos-stat-label">Pendientes</span>
            </div>
            <div class="anticipos-stat">
                <span class="anticipos-stat-number">{{ total_monto|currency_gtq }}</span>
                <span class="anticipos-stat-label">Monto Total</span>
            </div>
        </div>
    </div>

    <!-- Acciones Rápidas -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0" style="color: #1e3a8a;">
            <i class="fas fa-list me-2"></i>Lista de Anticipos
        </h5>
        <a href="{% url 'anticipo_create' %}" class="btn btn-primary" style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); border: none; border-radius: 8px; padding: 0.6rem 1.5rem;">
            <i class="fas fa-plus me-2"></i>Nuevo Anticipo
        </a>
    </div>

    <!-- Filtros y tabla -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Anticipos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ anticipos.count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Aplicados
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ anticipos_aplicados }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pendientes
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ anticipos_pendientes }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Monto Total
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{monto_total|currency_gtq}}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Anticipos -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-list me-2"></i>
                Lista de Anticipos
            </h6>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-filter me-1"></i>
                    Filtros
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <li><a class="dropdown-item" href="?estado=todos">Todos</a></li>
                    <li><a class="dropdown-item" href="?estado=pendiente">Pendientes</a></li>
                    <li><a class="dropdown-item" href="?estado=aplicado">Aplicados</a></li>
                    <li><a class="dropdown-item" href="?estado=cancelado">Cancelados</a></li>
                </ul>
            </div>
        </div>
        <div class="card-body">
            {% if anticipos %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Número</th>
                            <th>Cliente</th>
                            <th>Proyecto</th>
                            <th>Monto</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for anticipo in anticipos %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="fas fa-hand-holding-usd"></i>
                                    </div>
                                    <div>
                                        <strong>{{ anticipo.numero_anticipo }}</strong>
                                        <br>
                                        <small class="text-muted">{{ anticipo.tipo }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>
                                    <strong>{{ anticipo.cliente.razon_social }}</strong>
                                    <br>
                                    <small class="text-muted">{{ anticipo.cliente.nit }}</small>
                                </div>
                            </td>
                            <td>
                                <div>
                                    <strong>{{ anticipo.proyecto.nombre }}</strong>
                                    <br>
                                    <small class="text-muted">{{ anticipo.proyecto.ubicacion }}</small>
                                </div>
                            </td>
                            <td>
                                <div class="text-end">
                                    <span class="h6 text-success mb-0">{{anticipo.monto|currency_gtq}}</span>
                                    {% if anticipo.total_aplicado > 0 %}
                                    <br>
                                    <small class="text-muted">Aplicado: {{anticipo.total_aplicado|currency_gtq}}</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div>
                                    <strong>{{ anticipo.fecha_recepcion|date:"d/m/Y" }}</strong>
                                    <br>
                                    <small class="text-muted">{{ anticipo.fecha_creacion|date:"H:i" }}</small>
                                </div>
                            </td>
                            <td>
                                {% if anticipo.estado == 'pendiente' %}
                                    <span class="badge bg-warning text-dark">Pendiente</span>
                                {% elif anticipo.estado == 'aplicado' %}
                                    <span class="badge bg-primary">Aplicado</span>
                                {% elif anticipo.estado == 'liquidado' %}
                                    <span class="badge bg-success">Liquidado</span>
                                {% elif anticipo.estado == 'cancelado' %}
                                    <span class="badge bg-danger">Cancelado</span>
                                {% elif anticipo.estado == 'devuelto' %}
                                    <span class="badge bg-info">Devuelto</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{% url 'anticipo_detail' anticipo.id %}" class="btn btn-sm btn-outline-primary" title="Ver detalle">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'anticipo_edit' anticipo.id %}" class="btn btn-sm btn-outline-warning" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% if anticipo.estado == 'pendiente' %}
                                    <a href="{% url 'aplicar_anticipo' anticipo.id %}" class="btn btn-sm btn-outline-success" title="Aplicar">
                                        <i class="fas fa-check"></i>
                                    </a>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm btn-outline-danger" title="Eliminar" 
                                            data-anticipo-id="{{ anticipo.id }}"
                                            data-numero="{{ anticipo.numero_anticipo|escapejs }}"
                                            data-cliente="{{ anticipo.cliente.razon_social|escapejs }}"
                                            data-proyecto="{{ anticipo.proyecto.nombre|escapejs }}"
                                            data-monto="{{ anticipo.monto }}"
                                            data-estado="{{ anticipo.estado|escapejs }}"
                                            onclick="confirmarEliminarAnticipoFromButton(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay anticipos registrados</h5>
                <p class="text-muted">Comienza creando el primer anticipo para un cliente o proyecto.</p>
                <a href="{% url 'anticipo_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>
                    Crear Primer Anticipo
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Función para confirmar eliminación de anticipo desde el botón
function confirmarEliminarAnticipoFromButton(button) {
    const anticipoId = button.getAttribute('data-anticipo-id');
    const numeroAnticipo = button.getAttribute('data-numero');
    const clienteAnticipo = button.getAttribute('data-cliente');
    const proyectoAnticipo = button.getAttribute('data-proyecto');
    const montoAnticipo = 'Q' + parseFloat(button.getAttribute('data-monto')).toFixed(2);
    const estadoAnticipo = button.getAttribute('data-estado');
    
    // Actualizar el contenido del modal con la información del anticipo
    document.getElementById('numeroAnticipoEliminar').textContent = numeroAnticipo;
    document.getElementById('clienteAnticipoEliminar').textContent = clienteAnticipo;
    document.getElementById('proyectoAnticipoEliminar').textContent = proyectoAnticipo;
    document.getElementById('montoAnticipoEliminar').textContent = montoAnticipo;
    document.getElementById('estadoAnticipoEliminar').textContent = estadoAnticipo;
    document.getElementById('btnConfirmarEliminacionAnticipo').href = `/anticipos/${anticipoId}/eliminar/`;
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('confirmarEliminacionAnticipoModal'));
    modal.show();
}

// Función para mostrar notificaciones
function showSuccessNotification(message) {
    // Crear notificación toast moderna
    const notification = document.createElement('div');
    notification.className = 'modern-notification alert-success';
    notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="notification-text">
                <strong>Éxito</strong><br>
                ${message}
            </div>
        </div>
    `;
    
    // Agregar al contenedor de notificaciones
    let container = document.getElementById('notification-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            width: 100%;
        `;
        document.body.appendChild(container);
    }
    
    container.appendChild(notification);
    
    // Remover después de 3 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}
</script>

<!-- Modal de Confirmación de Eliminación de Anticipo -->
<div class="modal fade" id="confirmarEliminacionAnticipoModal" tabindex="-1" aria-labelledby="confirmarEliminacionAnticipoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmarEliminacionAnticipoModalLabel">
                    <i class="fas fa-trash me-2"></i>Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="mb-3">
                        <i class="fas fa-hand-holding-usd fa-3x text-danger"></i>
                    </div>
                    <h6 class="mb-3">¿Estás seguro de que quieres eliminar este anticipo?</h6>
                    <div class="alert alert-warning">
                        <strong>⚠️ Advertencia:</strong> Esta acción eliminará permanentemente el anticipo del sistema.
                        <br><br>
                        <div class="row">
                            <div class="col-6">
                                <strong>Número:</strong><br>
                                <span id="numeroAnticipoEliminar" class="fw-bold"></span>
                            </div>
                            <div class="col-6">
                                <strong>Cliente:</strong><br>
                                <span id="clienteAnticipoEliminar"></span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <strong>Proyecto:</strong><br>
                                <span id="proyectoAnticipoEliminar"></span>
                            </div>
                            <div class="col-6">
                                <strong>Monto:</strong><br>
                                <span id="montoAnticipoEliminar" class="text-danger fw-bold"></span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <strong>Estado:</strong><br>
                                <span id="estadoAnticipoEliminar" class="badge bg-warning text-dark"></span>
                            </div>
                        </div>
                    </div>
                    <!-- Botón de ayuda contextual -->
                    <div class="mt-2">
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="mostrarAyudaAnticipos()">
                            <i class="fas fa-question-circle me-1"></i>Ayuda sobre Anticipos
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <a href="#" id="btnConfirmarEliminacionAnticipo" class="btn btn-danger">
                    <i class="fas fa-trash me-2"></i>Eliminar Anticipo
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Función para mostrar ayuda sobre anticipos usando notificaciones toast
function mostrarAyudaAnticipos() {
    // Mostrar información sobre eliminación de anticipos
    if (typeof toastNotification !== 'undefined') {
        toastNotification.info(
            'Información sobre Anticipos',
            'Esta acción no se puede deshacer. Se eliminarán todos los registros relacionados al anticipo.',
            6000
        );
        
        // Mostrar información adicional después de un breve delay
        setTimeout(() => {
            toastNotification.warning(
                'Recomendaciones para Anticipos',
                'Si el anticipo ya fue aplicado, se recomienda cambiar su estado en lugar de eliminarlo. Se actualizarán automáticamente los totales del proyecto.',
                6000
            );
        }, 1000);
    } else {
        // Fallback si toastNotification no está disponible
        alert('Información sobre Anticipos:\n\n• Esta acción no se puede deshacer\n• Se eliminarán todos los registros relacionados al anticipo\n• Si el anticipo ya fue aplicado, se recomienda cambiar su estado\n• Se actualizarán automáticamente los totales del proyecto');
    }
}
</script>

{% endblock %}

{% extends "base.html" %}
{% load custom_filters %}

{% block title %}Crear Egreso - Sistema de Construcción{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="hero-content">
        <h1 class="hero-title">
            <i class="fas fa-plus-circle me-3"></i>Crear Nuevo Egreso
        </h1>
        <p class="hero-subtitle">
            Registra un nuevo egreso en el sistema de construcción
        </p>
        
        <!-- Barra de Progreso -->
        <div class="progress mb-3" style="max-width: 400px; margin: 0 auto;">
            <div class="progress-bar bg-success" id="progressBar" style="width: 0%"></div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Formulario Principal -->
    <div class="col-lg-8">
        <div class="form-container">
            <div class="form-header">
                <div class="form-header-icon">
                    <i class="fas fa-edit"></i>
                </div>
                <h4 class="form-header-title">Información del Egreso</h4>
            </div>
            
            <form method="post" id="egresoForm">
                {% csrf_token %}
                
                <!-- Sección de Información Básica -->
                <div class="card-modern mb-4">
                    <div class="card-header-modern">
                        <div class="card-header-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <h5 class="card-header-title">Información Básica</h5>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.descripcion.id_for_label }}" class="form-label">
                            <i class="fas fa-tag me-1"></i>Descripción del Egreso
                        </label>
                        {{ form.descripcion }}
                        <div class="invalid-feedback" id="descripcion-error"></div>
                        <div class="valid-feedback" id="descripcion-success"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.categoria.id_for_label }}" class="form-label">
                            <i class="fas fa-folder me-1"></i>Categoría
                        </label>
                        {{ form.categoria }}
                        <div class="invalid-feedback" id="categoria-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.monto.id_for_label }}" class="form-label">
                            <i class="fas fa-dollar-sign me-1"></i>Monto (Q)
                        </label>
                        {{ form.monto }}
                        <div class="invalid-feedback" id="monto-error"></div>
                        <div class="valid-feedback" id="monto-success"></div>
                    </div>
                </div>
                
                <!-- Sección de Proyecto y Fecha -->
                <div class="card-modern mb-4">
                    <div class="card-header-modern">
                        <div class="card-header-icon">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <h5 class="card-header-title">Proyecto y Fecha</h5>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.proyecto.id_for_label }}" class="form-label">
                            <i class="fas fa-building me-1"></i>Proyecto (Opcional)
                        </label>
                        {{ form.proyecto }}
                        <div class="invalid-feedback" id="proyecto-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.fecha_egreso.id_for_label }}" class="form-label">
                            <i class="fas fa-calendar me-1"></i>Fecha del Egreso
                        </label>
                        {{ form.fecha_egreso }}
                        <div class="invalid-feedback" id="fecha_egreso-error"></div>
                    </div>
                </div>
                
                <!-- Sección de Observaciones -->
                <div class="card-modern mb-4">
                    <div class="card-header-modern">
                        <div class="card-header-icon">
                            <i class="fas fa-comment"></i>
                        </div>
                        <h5 class="card-header-title">Observaciones</h5>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>Observaciones Adicionales
                        </label>
                        {{ form.observaciones }}
                        <div class="invalid-feedback" id="observaciones-error"></div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success w-100" id="submitBtn">
                    <i class="fas fa-save me-2"></i>Crear Egreso
                </button>
            </form>
        </div>
    </div>
    
    <!-- Sidebar Informativo -->
    <div class="col-lg-4">
        <div class="info-sidebar">
            <!-- Información del Sistema -->
            <div class="info-section info mb-4">
                <i class="fas fa-info-circle"></i>
                <h6>Información del Sistema</h6>
                <ul>
                    <li><strong>Usuario:</strong> {{ user.username }}</li>
                    <li><strong>Fecha:</strong> <span id="currentDate"></span></li>
                    <li><strong>Hora:</strong> <span id="currentTime"></span></li>
                </ul>
            </div>
            
            <!-- Vista Previa -->
            <div class="info-section info mb-4">
                <i class="fas fa-eye"></i>
                <h6>Vista Previa</h6>
                <div class="info-list">
                    <li>
                        <span class="info-label">Descripción:</span>
                        <span class="info-value" id="preview-descripcion">-</span>
                    </li>
                    <li>
                        <span class="info-label">Categoría:</span>
                        <span class="info-value" id="preview-categoria">-</span>
                    </li>
                    <li>
                        <span class="info-label">Monto:</span>
                        <span class="info-value" id="preview-monto">-</span>
                    </li>
                    <li>
                        <span class="info-label">Total:</span>
                        <span class="info-value" id="preview-total">$0.00</span>
                    </li>
                </div>
            </div>
            
            <!-- Ayuda -->
            <div class="info-section info">
                <i class="fas fa-question-circle"></i>
                <h6>Ayuda</h6>
                <ul>
                    <li>Completa todos los campos obligatorios marcados con <span class="text-danger">*</span></li>
                    <li>La descripción debe ser clara y específica</li>
                    <li>Selecciona la categoría más apropiada</li>
                    <li>Verifica que el monto sea correcto</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar fecha y hora actual
    function updateDateTime() {
        const now = new Date();
        document.getElementById('currentDate').textContent = now.toLocaleDateString('es-GT');
        document.getElementById('currentTime').textContent = now.toLocaleTimeString('es-GT');
    }
    
    updateDateTime();
    setInterval(updateDateTime, 1000);
    
    // Elementos del formulario
    const form = document.getElementById('egresoForm');
    const descripcionInput = document.getElementById('{{ form.descripcion.id_for_label }}');
    const categoriaInput = document.getElementById('{{ form.categoria.id_for_label }}');
    const montoInput = document.getElementById('{{ form.monto.id_for_label }}');
    const proyectoInput = document.getElementById('{{ form.proyecto.id_for_label }}');
    const fechaInput = document.getElementById('{{ form.fecha_egreso.id_for_label }}');
    const observacionesInput = document.getElementById('{{ form.observaciones.id_for_label }}');
    
    // Barra de progreso
    const progressBar = document.getElementById('progressBar');
    
    // Función para actualizar la barra de progreso
    function updateProgress() {
        const fields = [descripcionInput, categoriaInput, montoInput, fechaInput];
        const filledFields = fields.filter(field => field.value.trim() !== '').length;
        const progress = (filledFields / fields.length) * 100;
        progressBar.style.width = progress + '%';
    }
    
    // Función para validar campo en tiempo real
    function validateField(field, fieldName) {
        const value = field.value.trim();
        const errorElement = document.getElementById(fieldName + '-error');
        const successElement = document.getElementById(fieldName + '-success');
        
        // Limpiar estados previos
        field.classList.remove('is-valid', 'is-invalid');
        errorElement.textContent = '';
        successElement.textContent = '';
        
        if (value === '') {
            field.classList.add('is-invalid');
            errorElement.textContent = 'Este campo es obligatorio';
            return false;
        }
        
        // Validaciones específicas
        if (fieldName === 'monto') {
            const monto = parseFloat(value);
            if (isNaN(monto) || monto <= 0) {
                field.classList.add('is-invalid');
                errorElement.textContent = 'El monto debe ser un número mayor a 0';
                return false;
            }
        }
        
        if (fieldName === 'descripcion' && value.length < 10) {
            field.classList.add('is-invalid');
            errorElement.textContent = 'La descripción debe tener al menos 10 caracteres';
            return false;
        }
        
        // Campo válido
        field.classList.add('is-valid');
        successElement.textContent = 'Campo válido';
        return true;
    }
    
    // Función para actualizar vista previa
    function updatePreview() {
        const descripcion = descripcionInput.value || '-';
        const categoria = categoriaInput.options[categoriaInput.selectedIndex]?.text || '-';
        const monto = montoInput.value || '0.00';
        
        document.getElementById('preview-descripcion').textContent = descripcion.length > 30 ? descripcion.substring(0, 30) + '...' : descripcion;
        document.getElementById('preview-categoria').textContent = categoria;
        document.getElementById('preview-monto').textContent = 'Q' + monto;
        document.getElementById('preview-total').textContent = 'Q' + monto;
    }
    
    // Event listeners para validación en tiempo real
    descripcionInput.addEventListener('input', function() {
        validateField(this, 'descripcion');
        updatePreview();
        updateProgress();
    });
    
    categoriaInput.addEventListener('change', function() {
        validateField(this, 'categoria');
        updatePreview();
        updateProgress();
    });
    
    montoInput.addEventListener('input', function() {
        validateField(this, 'monto');
        updatePreview();
        updateProgress();
    });
    
    fechaInput.addEventListener('change', function() {
        validateField(this, 'fecha_egreso');
        updateProgress();
    });
    
    // Validación del formulario antes de enviar
    form.addEventListener('submit', function(e) {
        const isDescripcionValid = validateField(descripcionInput, 'descripcion');
        const isCategoriaValid = validateField(categoriaInput, 'categoria');
        const isMontoValid = validateField(montoInput, 'monto');
        const isFechaValid = validateField(fechaInput, 'fecha_egreso');
        
        if (!isDescripcionValid || !isCategoriaValid || !isMontoValid || !isFechaValid) {
            e.preventDefault();
            alert('Por favor, corrige los errores en el formulario antes de continuar.');
            return false;
        }
        
        // Deshabilitar botón y mostrar loading
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando...';
    });
    
    // Inicializar vista previa
    updatePreview();
    updateProgress();
    
    // Aplicar estilos a los campos del formulario
    const formFields = [descripcionInput, categoriaInput, montoInput, proyectoInput, fechaInput, observacionesInput];
    formFields.forEach(field => {
        if (field) {
            field.classList.add('form-control');
        }
    });
});
</script>
{% endblock %}

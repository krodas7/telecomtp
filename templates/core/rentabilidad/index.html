{% extends "base.html" %}
{% load custom_filters %}

{% block title %}Análisis de Rentabilidad - Sistema de Construcción{% endblock %}

{% block extra_css %}
<style>
    /* ===== DISEÑO EJECUTIVO PROFESIONAL - RENTABILIDAD ===== */
    
    body {
        background: #f1f5f9;
    }
    
    /* Header Ejecutivo */
    .rentabilidad-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .rentabilidad-header h1 {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        letter-spacing: 0.5px;
        color: white !important;
    }
    
    .rentabilidad-header p {
        font-size: 0.95rem;
        opacity: 0.85;
        margin: 0;
        color: white !important;
    }
    
    /* Filtros */
    .filtros-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    
    .filtros-card h6 {
        color: #1e3a8a;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .form-select, .form-control {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.6rem 1rem;
    }
    
    .form-select:focus, .form-control:focus {
        border-color: #1e40af;
        box-shadow: 0 0 0 3px rgba(30,64,175,0.1);
    }
    
    .btn-filtrar {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        border: none;
        color: white;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-filtrar:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(30,58,138,0.3);
        color: white;
    }
    
    .btn-reset {
        border: 1px solid #cbd5e1;
        color: #64748b;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        background: white;
        transition: all 0.3s ease;
    }
    
    .btn-reset:hover {
        background: #f8fafc;
        border-color: #94a3b8;
        color: #475569;
    }
    
    /* Tarjetas de Métricas */
    .metricas-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .metrica-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        border-left: 4px solid;
    }
    
    .metrica-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.12);
    }
    
    .metrica-card.ingresos {
        border-left-color: #10b981;
    }
    
    .metrica-card.gastos {
        border-left-color: #ef4444;
    }
    
    .metrica-card.rentabilidad {
        border-left-color: #f59e0b;
    }
    
    .metrica-card.margen {
        border-left-color: #3b82f6;
    }
    
    .metrica-icono {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .metrica-card.ingresos .metrica-icono {
        background: rgba(16,185,129,0.1);
        color: #10b981;
    }
    
    .metrica-card.gastos .metrica-icono {
        background: rgba(239,68,68,0.1);
        color: #ef4444;
    }
    
    .metrica-card.rentabilidad .metrica-icono {
        background: rgba(245,158,11,0.1);
        color: #f59e0b;
    }
    
    .metrica-card.margen .metrica-icono {
        background: rgba(59,130,246,0.1);
        color: #3b82f6;
    }
    
    .metrica-titulo {
        font-size: 0.85rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }
    
    .metrica-valor {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }
    
    .metrica-card.ingresos .metrica-valor {
        color: #10b981;
    }
    
    .metrica-card.gastos .metrica-valor {
        color: #ef4444;
    }
    
    .metrica-subtitulo {
        font-size: 0.8rem;
        color: #94a3b8;
    }
    
    .metrica-tendencia {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.85rem;
        font-weight: 600;
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        margin-top: 0.5rem;
    }
    
    .tendencia-positiva {
        background: rgba(16,185,129,0.1);
        color: #10b981;
    }
    
    .tendencia-negativa {
        background: rgba(239,68,68,0.1);
        color: #ef4444;
    }
    
    .tendencia-neutral {
        background: rgba(148,163,184,0.1);
        color: #64748b;
    }
    
    /* Gráficos */
    .graficos-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .grafico-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    
    .grafico-card h6 {
        color: #1e3a8a;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .grafico-placeholder {
        height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8fafc;
        border-radius: 8px;
        color: #94a3b8;
        flex-direction: column;
        gap: 1rem;
    }
    
    .grafico-placeholder i {
        font-size: 3rem;
        opacity: 0.3;
    }
    
    /* Tabla de Proyectos */
    .proyectos-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }
    
    .proyectos-card h6 {
        color: #1e3a8a;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .table-rentabilidad {
        margin: 0;
    }
    
    .table-rentabilidad thead th {
        background: #f8fafc;
        color: #475569;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
        padding: 1rem;
    }
    
    .table-rentabilidad tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-color: #f1f5f9;
    }
    
    .table-rentabilidad tbody tr:hover {
        background: #f8fafc;
    }
    
    .proyecto-nombre {
        font-weight: 600;
        color: #1e293b;
    }
    
    .proyecto-cliente {
        font-size: 0.85rem;
        color: #64748b;
    }
    
    .badge-estado {
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .estado-planificacion { background: #dbeafe; color: #1e40af; }
    .estado-en_progreso { background: #ddd6fe; color: #6d28d9; }
    .estado-completado { background: #d1fae5; color: #047857; }
    .estado-en_pausa { background: #fef3c7; color: #92400e; }
    
    /* Botones de Acción */
    .btn-exportar {
        background: white;
        border: 1px solid #cbd5e1;
        color: #475569;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-exportar:hover {
        background: #f8fafc;
        border-color: #94a3b8;
        color: #1e293b;
    }
    
    .acciones-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .acciones-botones {
        display: flex;
        gap: 0.75rem;
    }
    
    /* Mensaje vacío */
    .empty-message {
        text-align: center;
        padding: 3rem;
        color: #94a3b8;
    }
    
    .empty-message i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
        .metricas-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .graficos-row {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 768px) {
        .metricas-grid {
            grid-template-columns: 1fr;
        }
        
        .rentabilidad-header h1 {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Header -->
    <div class="rentabilidad-header">
        <h1>
        <i class="fas fa-chart-line me-2"></i>Análisis de Rentabilidad
        </h1>
        <p>Panel ejecutivo de control financiero y rendimiento</p>
    </div>
    
    <!-- Acciones -->
    <div class="acciones-header">
        <h2 class="mb-0" style="color: #1e3a8a; font-size: 1.2rem; font-weight: 600;">
            <i class="fas fa-filter me-2"></i>Filtros y Reportes
    </h2>
        <div class="acciones-botones">
            <button class="btn btn-exportar" onclick="window.print()">
            <i class="fas fa-print me-2"></i>Imprimir
        </button>
            <button class="btn btn-exportar">
                <i class="fas fa-download me-2"></i>Exportar
            </button>
        </div>
</div>

    <!-- Filtros -->
    <div class="filtros-card">
        <h6>
            <i class="fas fa-calendar-alt me-2"></i>Filtros de Período
        </h6>
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="periodo" class="form-label">Período</label>
                <select name="periodo" id="periodo" class="form-select">
                    <option value="todos" {% if periodo_seleccionado == 'todos' %}selected{% endif %}>Todos los Datos</option>
                    <option value="mes" {% if periodo_seleccionado == 'mes' or not periodo_seleccionado %}selected{% endif %}>Último Mes</option>
                    <option value="trimestre" {% if periodo_seleccionado == 'trimestre' %}selected{% endif %}>Último Trimestre</option>
                    <option value="año" {% if periodo_seleccionado == 'año' %}selected{% endif %}>Último Año</option>
                    <option value="personalizado" {% if periodo_seleccionado == 'personalizado' %}selected{% endif %}>Personalizado</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="fecha_inicio" class="form-label">Fecha Inicio</label>
                <input type="date" name="fecha_inicio" id="fecha_inicio" class="form-control" value="{{ fecha_inicio_str }}">
            </div>
            <div class="col-md-3">
                <label for="fecha_fin" class="form-label">Fecha Fin</label>
                <input type="date" name="fecha_fin" id="fecha_fin" class="form-control" value="{{ fecha_fin_str }}">
            </div>
            <div class="col-md-3 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-filtrar flex-fill">
                    <i class="fas fa-search me-2"></i>Filtrar
                </button>
                <a href="{% url 'rentabilidad' %}" class="btn btn-reset">
                    <i class="fas fa-undo"></i>
                </a>
            </div>
        </form>
</div>

    <!-- Métricas Principales -->
    <div class="metricas-grid">
        <div class="metrica-card ingresos">
            <div class="metrica-icono">
                <i class="fas fa-arrow-trend-up"></i>
            </div>
            <div class="metrica-titulo">Ingresos</div>
            <div class="metrica-valor">{{ ingresos|currency_gtq }}</div>
            <div class="metrica-subtitulo">Período seleccionado</div>
            {% if tendencia_ingresos %}
                <div class="metrica-tendencia {% if tendencia_ingresos > 0 %}tendencia-positiva{% elif tendencia_ingresos < 0 %}tendencia-negativa{% else %}tendencia-neutral{% endif %}">
                    <i class="fas fa-arrow-{% if tendencia_ingresos > 0 %}up{% elif tendencia_ingresos < 0 %}down{% else %}right{% endif %}"></i>
                    {{ tendencia_ingresos|floatformat:1|default:"0.0" }}% vs mes anterior
                </div>
            {% endif %}
        </div>
        
        <div class="metrica-card gastos">
            <div class="metrica-icono">
                <i class="fas fa-arrow-trend-down"></i>
            </div>
            <div class="metrica-titulo">Gastos</div>
            <div class="metrica-valor">{{ gastos|currency_gtq }}</div>
            <div class="metrica-subtitulo">Período seleccionado</div>
            {% if tendencia_gastos %}
                <div class="metrica-tendencia {% if tendencia_gastos < 0 %}tendencia-positiva{% elif tendencia_gastos > 0 %}tendencia-negativa{% else %}tendencia-neutral{% endif %}">
                    <i class="fas fa-arrow-{% if tendencia_gastos > 0 %}up{% elif tendencia_gastos < 0 %}down{% else %}right{% endif %}"></i>
                    {{ tendencia_gastos|floatformat:1|default:"0.0" }}% vs mes anterior
                </div>
            {% endif %}
        </div>
        
        <div class="metrica-card rentabilidad">
            <div class="metrica-icono">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metrica-titulo">Rentabilidad Neta</div>
            <div class="metrica-valor" style="color: {% if rentabilidad_bruta >= 0 %}#10b981{% else %}#ef4444{% endif %};">
                {{ rentabilidad_bruta|currency_gtq }}
            </div>
            <div class="metrica-subtitulo">Ingresos - Gastos</div>
            {% if tendencia_rentabilidad %}
                <div class="metrica-tendencia {% if tendencia_rentabilidad > 0 %}tendencia-positiva{% elif tendencia_rentabilidad < 0 %}tendencia-negativa{% else %}tendencia-neutral{% endif %}">
                    <i class="fas fa-arrow-{% if tendencia_rentabilidad > 0 %}up{% elif tendencia_rentabilidad < 0 %}down{% else %}right{% endif %}"></i>
                    {{ tendencia_rentabilidad|floatformat:1|default:"0.0" }}% vs mes anterior
                </div>
            {% endif %}
</div>

        <div class="metrica-card margen">
            <div class="metrica-icono">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="metrica-titulo">% Margen</div>
            <div class="metrica-valor" style="color: {% if margen_rentabilidad >= 0 %}#10b981{% else %}#ef4444{% endif %};">
                {{ margen_rentabilidad|floatformat:1 }}%
            </div>
            <div class="metrica-subtitulo">Rentabilidad/Ingresos</div>
        </div>
    </div>
    
    <!-- Gráficos -->
    <div class="graficos-row">
        <div class="grafico-card">
            <h6>
                <i class="fas fa-chart-area"></i>
                Tendencias Mensuales
                </h6>
            <div class="grafico-placeholder">
                <canvas id="tendenciasChart" height="80"></canvas>
            </div>
        </div>
        
        <div class="grafico-card">
            <h6>
                <i class="fas fa-chart-pie"></i>
                Gastos por Categoría
            </h6>
            <div class="grafico-placeholder">
                <canvas id="categoriasChart" height="80"></canvas>
        </div>
    </div>
</div>

    <!-- Tabla de Proyectos -->
    <div class="proyectos-card">
        <h6>
            <i class="fas fa-project-diagram"></i>
            Rentabilidad por Proyecto
        </h6>
        <div class="table-responsive">
            <table class="table table-rentabilidad">
                <thead>
                    <tr>
                        <th>Proyecto</th>
                        <th>Cliente</th>
                        <th class="text-end">Ingresos</th>
                        <th class="text-end">Gastos</th>
                        <th class="text-end">Rentabilidad</th>
                        <th class="text-end">Margen %</th>
                        <th class="text-center">Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% if proyectos_rentabilidad %}
                        {% for proyecto in proyectos_rentabilidad %}
                    <tr>
                        <td>
                                <div class="proyecto-nombre">{{ proyecto.nombre }}</div>
                        </td>
                        <td>
                                <div class="proyecto-cliente">{{ proyecto.cliente|default:"-" }}</div>
                            </td>
                            <td class="text-end" style="color: #10b981; font-weight: 600;">
                                {{ proyecto.ingresos|currency_gtq }}
                            </td>
                            <td class="text-end" style="color: #ef4444; font-weight: 600;">
                                {{ proyecto.gastos|currency_gtq }}
                            </td>
                            <td class="text-end" style="font-weight: 700; color: {% if proyecto.rentabilidad >= 0 %}#10b981{% else %}#ef4444{% endif %};">
                                {{ proyecto.rentabilidad|currency_gtq }}
                            </td>
                            <td class="text-end" style="font-weight: 600;">
                                {{ proyecto.margen|floatformat:1 }}%
                            </td>
                            <td class="text-center">
                                <span class="badge-estado estado-{{ proyecto.estado }}">
                                    {{ proyecto.get_estado_display|default:proyecto.estado }}
                            </span>
                        </td>
                    </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                            <td colspan="7" class="empty-message">
                                <i class="fas fa-inbox"></i>
                                <div>No hay datos de proyectos en el período seleccionado</div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de Tendencias
    const tendenciasCtx = document.getElementById('tendenciasChart');
    if (tendenciasCtx) {
    new Chart(tendenciasCtx, {
        type: 'line',
        data: {
                labels: {{ meses_tendencia|safe }},
                datasets: [
                    {
                label: 'Ingresos',
                        data: {{ ingresos_tendencia|safe }},
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16,185,129,0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                label: 'Gastos',
                        data: {{ gastos_tendencia|safe }},
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239,68,68,0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
        },
        options: {
            responsive: true,
                maintainAspectRatio: false,
            plugins: {
                    legend: {
                        position: 'top',
                    },
                title: {
                    display: true,
                        text: 'Evolución Financiera Mensual',
                        font: {
                            size: 14,
                            weight: 600
                        }
                }
            },
            scales: {
                y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Gráfico de Categorías
    const categoriasCtx = document.getElementById('categoriasChart');
    if (categoriasCtx) {
        const labels = {{ categorias_gastos_chart_labels|safe }};
        const data = {{ categorias_gastos_chart_data|safe }};
    
    new Chart(categoriasCtx, {
        type: 'doughnut',
        data: {
                labels: labels,
            datasets: [{
                    data: data,
                backgroundColor: [
                        '#ef4444',
                        '#f59e0b',
                        '#10b981',
                        '#3b82f6',
                        '#8b5cf6',
                        '#ec4899',
                        '#06b6d4',
                        '#84cc16'
                    ],
                    borderWidth: 0
            }]
        },
        options: {
            responsive: true,
                maintainAspectRatio: false,
            plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 11
                            }
                        }
                    },
                title: {
                    display: true,
                        text: 'Distribución de Gastos',
                        font: {
                            size: 14,
                            weight: 600
                        }
                    }
                }
            }
        });
    }
    
    // Control de fechas según período
    const periodoSelect = document.getElementById('periodo');
    const fechaInicio = document.getElementById('fecha_inicio');
    const fechaFin = document.getElementById('fecha_fin');
    
    if (periodoSelect) {
        periodoSelect.addEventListener('change', function() {
            const periodo = this.value;
        const hoy = new Date();
        
            if (periodo === 'personalizado') {
                fechaInicio.disabled = false;
                fechaFin.disabled = false;
            } else if (periodo === 'todos') {
                fechaInicio.value = '';
                fechaFin.value = '';
                fechaInicio.disabled = true;
                fechaFin.disabled = true;
            } else {
                fechaInicio.disabled = false;
                fechaFin.disabled = false;
                
                // Auto-calcular fechas
                let diasAtras = 30;
                if (periodo === 'trimestre') diasAtras = 90;
                if (periodo === 'año') diasAtras = 365;
                
                const fechaInicioCalc = new Date(hoy);
                fechaInicioCalc.setDate(hoy.getDate() - diasAtras);
                
                fechaInicio.value = fechaInicioCalc.toISOString().split('T')[0];
                fechaFin.value = hoy.toISOString().split('T')[0];
            }
        });
    }
});
</script>
{% endblock %}

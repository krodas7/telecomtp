{% extends "base.html" %}
{% load custom_filters %}

{% block title %}{{ cotizacion.numero_cotizacion }} - Sistema de Construcción{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-file-invoice-dollar me-2"></i>{{ cotizacion.numero_cotizacion }}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'cotizaciones_list' %}" class="btn btn-outline-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i>Volver
        </a>
        
        {% if cotizacion.estado not in 'aceptada,rechazada' %}
        <a href="{% url 'cotizacion_aprobar' cotizacion.id %}" class="btn btn-success me-2">
            <i class="fas fa-check me-1"></i>Aprobar
        </a>
        <a href="{% url 'cotizacion_rechazar' cotizacion.id %}" class="btn btn-danger me-2">
            <i class="fas fa-times me-1"></i>Rechazar
        </a>
        {% endif %}
        
        <a href="{% url 'cotizacion_pdf' cotizacion.id %}" class="btn btn-outline-info me-2">
            <i class="fas fa-file-pdf me-1"></i>PDF
        </a>
        <a href="{% url 'cotizacion_edit' cotizacion.id %}" class="btn btn-outline-warning me-2">
            <i class="fas fa-edit me-1"></i>Editar
        </a>
        <a href="{% url 'cotizacion_delete' cotizacion.id %}" class="btn btn-outline-danger">
            <i class="fas fa-trash me-1"></i>Eliminar
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Información de la Cotización
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><strong>Título:</strong></h6>
                        <p>{{ cotizacion.titulo }}</p>
                        
                        <h6><strong>Proyecto:</strong></h6>
                        <p>
                            <a href="{% url 'proyecto_dashboard' cotizacion.proyecto.id %}" class="text-decoration-none">
                                {{ cotizacion.proyecto.nombre }}
                            </a>
                        </p>
                        
                        <h6><strong>Cliente:</strong></h6>
                        <p>{{ cotizacion.cliente.razon_social }}</p>
                        
                        <h6><strong>Tipo de Cotización:</strong></h6>
                        <p>{{ cotizacion.get_tipo_cotizacion_display }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><strong>Estado:</strong></h6>
                        <p>
                            {% if cotizacion.estado == 'aceptada' %}
                                <span class="badge bg-success fs-6">{{ cotizacion.get_estado_display }}</span>
                            {% elif cotizacion.estado == 'enviada' %}
                                <span class="badge bg-primary fs-6">{{ cotizacion.get_estado_display }}</span>
                            {% elif cotizacion.estado == 'borrador' %}
                                <span class="badge bg-secondary fs-6">{{ cotizacion.get_estado_display }}</span>
                            {% elif cotizacion.estado == 'rechazada' %}
                                <span class="badge bg-danger fs-6">{{ cotizacion.get_estado_display }}</span>
                            {% elif cotizacion.estado == 'vencida' %}
                                <span class="badge bg-warning fs-6">{{ cotizacion.get_estado_display }}</span>
                            {% else %}
                                <span class="badge bg-dark fs-6">{{ cotizacion.get_estado_display }}</span>
                            {% endif %}
                        </p>
                        
                        <h6><strong>Fecha de Emisión:</strong></h6>
                        <p>{{ cotizacion.fecha_emision|date:"d/m/Y" }}</p>
                        
                        <h6><strong>Fecha de Vencimiento:</strong></h6>
                        <p>
                            {% if cotizacion.esta_vencida %}
                                <span class="text-danger">
                                    <i class="fas fa-exclamation-triangle me-1"></i>{{ cotizacion.fecha_vencimiento|date:"d/m/Y" }} (Vencida)
                                </span>
                            {% else %}
                                {{ cotizacion.fecha_vencimiento|date:"d/m/Y" }}
                                <small class="text-muted">({{ cotizacion.dias_para_vencer }} días restantes)</small>
                            {% endif %}
                        </p>
                        
                        {% if cotizacion.fecha_aceptacion %}
                        <h6><strong>Fecha de Aceptación:</strong></h6>
                        <p>{{ cotizacion.fecha_aceptacion|date:"d/m/Y" }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <hr>
                
                <h6><strong>Items de la Cotización:</strong></h6>
                {% if cotizacion.items.all %}
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Descripción</th>
                                    <th class="text-end">Cantidad</th>
                                    <th class="text-end">Precio Unitario</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cotizacion.items.all %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ item.descripcion }}</td>
                                    <td class="text-end">{{ item.cantidad }}</td>
                                    <td class="text-end">${{ item.precio_unitario|floatformat:2 }}</td>
                                    <td class="text-end"><strong>${{ item.total|floatformat:2 }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                                    <td class="text-end"><strong>${{ cotizacion.monto_subtotal|floatformat:2 }}</strong></td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>ITBMS (7%):</strong></td>
                                    <td class="text-end"><strong>${{ cotizacion.monto_iva|floatformat:2 }}</strong></td>
                                </tr>
                                <tr class="table-primary">
                                    <td colspan="4" class="text-end"><strong>TOTAL:</strong></td>
                                    <td class="text-end"><strong class="text-white">${{ cotizacion.monto_total|floatformat:2 }}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>No hay items registrados en esta cotización.
                    </div>
                {% endif %}
                
                {% if cotizacion.descripcion %}
                <hr>
                <h6 class="mt-3"><strong>Descripción de Servicios:</strong></h6>
                <div class="bg-light p-3 rounded">
                    {{ cotizacion.descripcion|linebreaks }}
                </div>
                {% endif %}
                
                {% if cotizacion.condiciones_pago %}
                <h6 class="mt-3"><strong>Condiciones de Pago:</strong></h6>
                <div class="bg-light p-3 rounded">
                    {{ cotizacion.condiciones_pago|linebreaks }}
                </div>
                {% endif %}
                
                {% if cotizacion.terminos_condiciones %}
                <h6 class="mt-3"><strong>Términos y Condiciones:</strong></h6>
                <div class="bg-light p-3 rounded">
                    {{ cotizacion.terminos_condiciones|linebreaks }}
                </div>
                {% endif %}
                
                {% if cotizacion.observaciones %}
                <h6 class="mt-3"><strong>Observaciones Internas:</strong></h6>
                <div class="bg-light p-3 rounded">
                    {{ cotizacion.observaciones|linebreaks }}
                </div>
                {% endif %}
                
                {% if cotizacion.notas_cliente %}
                <h6 class="mt-3"><strong>Notas del Cliente:</strong></h6>
                <div class="bg-light p-3 rounded">
                    {{ cotizacion.notas_cliente|linebreaks }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Información Financiera -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-calculator me-2"></i>Información Financiera
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <strong>${{ cotizacion.monto_subtotal|floatformat:2 }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>ITBMS (7%):</span>
                    <strong>${{ cotizacion.monto_iva|floatformat:2 }}</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span><strong>Total:</strong></span>
                    <strong class="text-primary fs-5">${{ cotizacion.monto_total|floatformat:2 }}</strong>
                </div>
            </div>
        </div>
        
        <!-- Archivo Adjunto -->
        {% if cotizacion.archivo_cotizacion %}
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-file me-2"></i>Archivo Adjunto
                </h6>
            </div>
            <div class="card-body">
                <a href="{{ cotizacion.archivo_cotizacion.url }}" class="btn btn-outline-primary" target="_blank">
                    <i class="fas fa-download me-1"></i>Descargar Archivo
                </a>
            </div>
        </div>
        {% endif %}
        
        <!-- Información de Auditoría -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>Información de Auditoría
                </h6>
            </div>
            <div class="card-body">
                {% if cotizacion.creado_por %}
                <p><strong>Creado por:</strong><br>{{ cotizacion.creado_por.get_full_name|default:cotizacion.creado_por.username }}</p>
                {% endif %}
                <p><strong>Fecha de creación:</strong><br>{{ cotizacion.fecha_creacion|date:"d/m/Y H:i" }}</p>
                
                {% if cotizacion.modificado_por %}
                <p><strong>Modificado por:</strong><br>{{ cotizacion.modificado_por.get_full_name|default:cotizacion.modificado_por.username }}</p>
                {% endif %}
                <p><strong>Última modificación:</strong><br>{{ cotizacion.fecha_modificacion|date:"d/m/Y H:i" }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% extends "base.html" %}
{% load custom_filters %}

{% block title %}Nueva Factura - Telecom Technology{% endblock %}

{% block extra_css %}
<style>
    .create-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 2rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .form-container {
        background: white;
        border-radius: 20px;
        padding: 2.5rem;
        box-shadow: 0 8px 30px rgba(44, 62, 80, 0.1);
        margin-bottom: 2rem;
        border: none;
        position: relative;
        overflow: hidden;
    }
    
    .form-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }
    
    .form-group {
        margin-bottom: 2rem;
        position: relative;
    }
    
    .form-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-label i {
        color: #667eea;
        font-size: 1.1rem;
    }
    
    .form-control, .form-select {
        border: 2px solid #e0e0e0 !important;
        border-radius: 12px !important;
        padding: 1rem 1.2rem !important;
        font-size: 1rem !important;
        transition: all 0.3s ease !important;
        background: white !important;
        width: 100% !important;
        box-sizing: border-box !important;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea !important;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
        outline: none !important;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }
    
    .btn {
        padding: 1rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        cursor: pointer;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }
    
    .info-sidebar {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        padding: 2rem;
        border: none;
        position: sticky;
        top: 2rem;
    }
    
    .info-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #dee2e6;
    }
    
    .info-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .info-header-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .info-label {
        font-weight: 600;
        color: #495057;
    }
    
    .info-value {
        font-weight: 700;
        color: #667eea;
    }
    
    .info-alert {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 10px;
        padding: 1rem;
        margin-top: 2rem;
    }
    
    .info-alert i {
        color: #856404;
        margin-right: 0.5rem;
    }
    
    .info-alert h6 {
        color: #856404;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .info-alert p {
        color: #856404;
        margin: 0;
        font-size: 0.9rem;
    }
    
    .required {
        color: #dc3545;
    }
    
    .text-danger {
        color: #dc3545 !important;
    }
    
    .small {
        font-size: 0.875rem;
    }
    
    .mt-1 {
        margin-top: 0.25rem;
    }
    
    /* Vista previa de comprobante */
    .file-upload-wrapper {
        position: relative;
    }
    
    .comprobante-preview {
        background: #f8f9fa;
        border: 2px dashed #20bf6b;
        border-radius: 10px;
        padding: 1.5rem;
    }
    
    .preview-container {
        display: flex;
        align-items: center;
        gap: 1rem;
        position: relative;
    }
    
    .preview-image-container {
        width: 120px;
        height: 120px;
        border-radius: 10px;
        overflow: hidden;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #e9ecef;
        flex-shrink: 0;
    }
    
    .preview-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .preview-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
    }
    
    .preview-info {
        flex: 1;
        min-width: 0;
    }
    
    .preview-file-name {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        word-break: break-word;
    }
    
    .preview-file-size,
    .preview-file-type {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    
    .btn-remove-preview {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }
    
    .btn-remove-preview:hover {
        background: #c82333;
        transform: scale(1.1);
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
<div class="create-hero">
    <div class="create-hero-content">
        <h1 class="create-hero-title">
                <i class="fas fa-file-invoice"></i>
                Nueva Factura
        </h1>
        <p class="create-hero-subtitle">
                Crear una nueva factura para el proyecto
            </p>
    </div>
</div>

<div class="row">
    <!-- Formulario Principal -->
    <div class="col-lg-8">
        <div class="form-container">
                <form method="post" id="createForm" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- N√∫mero de Factura y Cliente -->
                <div class="form-row">
                    <div class="form-group">
                            <label for="{{ form.numero_factura.id_for_label }}" class="form-label">
                                <i class="fas fa-hashtag"></i>
                                N√∫mero de Factura <span class="required">*</span>
                        </label>
                            {{ form.numero_factura }}
                            {% if form.numero_factura.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.numero_factura.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                    </div>
                    
                    <div class="form-group">
                            <label for="{{ form.cliente.id_for_label }}" class="form-label">
                                <i class="fas fa-users"></i>
                                Cliente <span class="required">*</span>
                        </label>
                            {{ form.cliente }}
                            {% if form.cliente.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.cliente.errors %}
                                        {{ error }}
                            {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                </div>

                    <!-- Proyecto y Tipo -->
                <div class="form-row">
                    <div class="form-group">
                            <label for="{{ form.proyecto.id_for_label }}" class="form-label">
                                <i class="fas fa-project-diagram"></i>
                                Proyecto <span class="required">*</span>
                        </label>
                            {{ form.proyecto }}
                            {% if form.proyecto.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.proyecto.errors %}
                                        {{ error }}
                            {% endfor %}
                                </div>
                            {% endif %}
                            
                            <!-- Subproyectos (se muestran din√°micamente) -->
                            <div id="subproyecto-container-factura" class="mt-3" style="display: none;">
                                <label for="{{ form.subproyecto.id_for_label }}" class="form-label" style="font-size: 0.9rem; color: #6c757d;">
                                    <i class="fas fa-project-diagram"></i>
                                    Subproyecto (Opcional)
                                </label>
                                {{ form.subproyecto }}
                                {% if form.subproyecto.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.subproyecto.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="help-text" style="font-size: 0.85rem; color: #6c757d;">
                                    Selecciona un subproyecto si esta factura pertenece a uno espec√≠fico
                                </div>
                            </div>
                    </div>
                    
                    <div class="form-group">
                            <label for="{{ form.tipo.id_for_label }}" class="form-label">
                                <i class="fas fa-tag"></i>
                                Tipo de Factura
                        </label>
                            {{ form.tipo }}
                            {% if form.tipo.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.tipo.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                </div>

                    <!-- Estado -->
                    <div class="form-group">
                        <label for="{{ form.estado.id_for_label }}" class="form-label">
                            <i class="fas fa-check-circle"></i>
                            Estado <span class="required">*</span>
                        </label>
                        {{ form.estado }}
                        {% if form.estado.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.estado.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Fechas -->
                    <div class="form-row">
                    <div class="form-group">
                            <label for="{{ form.fecha_emision.id_for_label }}" class="form-label">
                                <i class="fas fa-calendar"></i>
                                Fecha de Emisi√≥n <span class="required">*</span>
                        </label>
                            {{ form.fecha_emision }}
                            {% if form.fecha_emision.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.fecha_emision.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.fecha_vencimiento.id_for_label }}" class="form-label">
                                <i class="fas fa-clock"></i>
                                Fecha de Vencimiento <span class="required">*</span>
                            </label>
                            {{ form.fecha_vencimiento }}
                            {% if form.fecha_vencimiento.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.fecha_vencimiento.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                    </div>
                </div>

                    <!-- Montos -->
                <div class="form-row">
                    <div class="form-group">
                            <label for="{{ form.monto_subtotal.id_for_label }}" class="form-label">
                                <i class="fas fa-dollar-sign"></i>
                                Subtotal ($) <span class="required">*</span>
                        </label>
                            {{ form.monto_subtotal }}
                            {% if form.monto_subtotal.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.monto_subtotal.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                    </div>
                    
                    <div class="form-group">
                            <label for="{{ form.porcentaje_itbms.id_for_label }}" class="form-label">
                                <i class="fas fa-percentage"></i>
                                Porcentaje de ITBMS
                        </label>
                            {{ form.porcentaje_itbms }}
                            {% if form.porcentaje_itbms.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.porcentaje_itbms.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- ITBMS y Total -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="{{ form.monto_iva.id_for_label }}" class="form-label">
                                <i class="fas fa-calculator"></i>
                                Monto ITBMS
                            </label>
                            {{ form.monto_iva }}
                            {% if form.monto_iva.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.monto_iva.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                </div>

                    <div class="form-group">
                            <label for="{{ form.monto_total.id_for_label }}" class="form-label">
                                <i class="fas fa-calculator"></i>
                                Total ($) <span class="required">*</span>
                        </label>
                            {{ form.monto_total }}
                            {% if form.monto_total.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.monto_total.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Descripci√≥n -->
                    <div class="form-group">
                        <label for="{{ form.descripcion_servicios.id_for_label }}" class="form-label">
                            <i class="fas fa-file-alt"></i>
                            Descripci√≥n de Servicios
                        </label>
                        {{ form.descripcion_servicios }}
                        {% if form.descripcion_servicios.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.descripcion_servicios.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                </div>

                    <!-- Comprobante -->
                    <div class="form-group">
                        <label for="{{ form.comprobante.id_for_label }}" class="form-label">
                            <i class="fas fa-file-upload"></i>
                            Comprobante
                        </label>
                        <div class="file-upload-wrapper">
                            <div class="d-flex align-items-center gap-2">
                                {{ form.comprobante }}
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearComprobanteFile()" id="clear-comprobante-btn" style="display: none;" title="Eliminar archivo seleccionado">
                                    <i class="fas fa-times"></i> Eliminar
                                </button>
                            </div>
                            {% if form.comprobante.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.comprobante.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="help-text" style="font-size: 0.875rem; color: #6c757d; margin-top: 0.5rem;">
                                Sube un comprobante de la factura (PDF, JPG, PNG) - M√°ximo 50MB
                            </div>
                            
                            <!-- Vista previa del archivo -->
                            <div id="comprobantePreview" class="comprobante-preview" style="display: none; margin-top: 1rem;">
                                <div class="preview-container">
                                    <div class="preview-image-container">
                                        <img id="previewComprobanteImage" src="" alt="Vista previa" class="preview-image" style="display: none;">
                                        <div id="previewComprobanteIcon" class="preview-icon">
                                            <i class="fas fa-file-pdf" style="font-size: 3rem; color: #dc3545;"></i>
                                        </div>
                                    </div>
                                    <div class="preview-info">
                                        <h6 id="previewComprobanteFileName" class="preview-file-name"></h6>
                                        <p id="previewComprobanteFileSize" class="preview-file-size"></p>
                                        <p id="previewComprobanteFileType" class="preview-file-type"></p>
                                    </div>
                                    <button type="button" class="btn-remove-preview" onclick="removeComprobantePreview()" title="Quitar archivo">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="form-group text-center">
                        <button type="submit" class="btn btn-primary me-3">
                            <i class="fas fa-save"></i>
                            Crear Factura
                        </button>
                        <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Sidebar de Informaci√≥n -->
    <div class="col-lg-4">
        <div class="info-sidebar">
            <div class="info-header">
                    <div class="info-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                <h4 class="info-header-title">Informaci√≥n √ötil</h4>
            </div>
            
            <div class="info-item">
                <span class="info-label">Total Clientes:</span>
                    <span class="info-value">{{ clientes.count }}</span>
            </div>
            
            <div class="info-item">
                <span class="info-label">Total Proyectos:</span>
                    <span class="info-value">{{ proyectos.count }}</span>
            </div>
            
            <div class="info-item">
                <span class="info-label">Facturas del Mes:</span>
                    <span class="info-value">{{ facturas_mes|default:"0" }}</span>
            </div>
            
            <div class="info-item">
                <span class="info-label">Total Facturado:</span>
                    <span class="info-value">${{ total_facturado|default:"0.00" }}</span>
            </div>
            
            <div class="info-alert">
                <i class="fas fa-lightbulb"></i>
                <h6>Consejos</h6>
                    <p>‚Ä¢ El ITBMS se calcula autom√°ticamente seg√∫n el porcentaje seleccionado</p>
                    <p>‚Ä¢ El total se actualiza autom√°ticamente al ingresar el subtotal</p>
                    <p>‚Ä¢ Aseg√∫rate de seleccionar el cliente y proyecto correctos</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('P√°gina de crear factura cargada');
    
    // ===== FILTRO DE PROYECTOS POR CLIENTE =====
    console.log('üîÑ Inicializando filtro de proyectos por cliente');
    
    // Obtener elementos del formulario - usar los IDs correctos
    const clienteSelect = document.getElementById('id_cliente');
    // El ID puede ser id_proyecto o id_proyecto_factura dependiendo del widget
    const proyectoSelect = document.getElementById('id_proyecto') || document.getElementById('id_proyecto_factura');
    
    // Debug: Verificar que los elementos se encontraron
    console.log('üîç Cliente select encontrado:', clienteSelect);
    console.log('üîç Proyecto select encontrado:', proyectoSelect);
    
    // Datos de proyectos por cliente (se pasan desde la vista)
    const proyectosPorCliente = {{ proyectos_por_cliente|safe }};
    
    // Debug: Verificar que los datos se cargaron correctamente
    console.log('üîç Proyectos por cliente cargados:', proyectosPorCliente);
    console.log('üîç Claves disponibles:', Object.keys(proyectosPorCliente));
    
    // Funci√≥n para filtrar proyectos por cliente
    function filtrarProyectosPorCliente() {
        console.log('üîÑ Funci√≥n filtrarProyectosPorCliente ejecutada');
        
        if (!clienteSelect || !proyectoSelect) {
            console.error('‚ùå No se encontraron los selects de cliente o proyecto');
            return;
        }
        
        const clienteId = clienteSelect.value;
        
        console.log('üîç Cliente seleccionado ID:', clienteId);
        console.log('üîç Tipo de clienteId:', typeof clienteId);
        
        // Guardar el valor actual del proyecto si existe
        const proyectoActual = proyectoSelect.value;
        
        // Limpiar opciones actuales
        proyectoSelect.innerHTML = '<option value="">Seleccionar proyecto...</option>';
        
        if (clienteId) {
            // Convertir clienteId a n√∫mero para comparar con las claves del objeto
            const clienteIdNum = parseInt(clienteId);
            console.log('üîç Cliente ID convertido a n√∫mero:', clienteIdNum);
            
            // Obtener proyectos del cliente seleccionado - probar ambas formas
            const proyectosCliente = proyectosPorCliente[clienteIdNum] || proyectosPorCliente[clienteId] || [];
            
            console.log('üîç Proyectos encontrados para cliente', clienteId, ':', proyectosCliente);
            console.log('üîç Cantidad de proyectos:', proyectosCliente.length);
            
            if (proyectosCliente.length > 0) {
                proyectosCliente.forEach(proyecto => {
                    const option = document.createElement('option');
                    option.value = proyecto.id;
                    option.textContent = proyecto.nombre;
                    // Restaurar selecci√≥n si el proyecto sigue siendo v√°lido
                    if (proyectoActual == proyecto.id) {
                        option.selected = true;
                    }
                    proyectoSelect.appendChild(option);
                    console.log('‚úÖ Agregado proyecto:', proyecto.nombre, 'con ID:', proyecto.id);
                });
                
                // Habilitar el select de proyectos
                proyectoSelect.disabled = false;
                console.log('‚úÖ Select de proyectos actualizado con', proyectosCliente.length, 'proyectos');
            } else {
                console.log('‚ö†Ô∏è No se encontraron proyectos para este cliente');
                // Agregar opci√≥n de "Sin proyectos"
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay proyectos disponibles para este cliente';
                option.disabled = true;
                proyectoSelect.appendChild(option);
                proyectoSelect.disabled = true;
            }
        } else {
            console.log('‚ö†Ô∏è No se seleccion√≥ ning√∫n cliente');
            // Deshabilitar el select de proyectos si no hay cliente seleccionado
            proyectoSelect.disabled = true;
        }
    }
    
    // Verificar que ambos elementos existen antes de continuar
    if (!clienteSelect) {
        console.error('‚ùå No se encontr√≥ el select de cliente con ID "id_cliente"');
    }
    
    if (!proyectoSelect) {
        console.error('‚ùå No se encontr√≥ el select de proyecto con ID "id_proyecto"');
    }
    
    // Agregar event listener al cambio de cliente
    if (clienteSelect && proyectoSelect) {
        clienteSelect.addEventListener('change', filtrarProyectosPorCliente);
        console.log('‚úÖ Event listener agregado al select de cliente');
        
        // Ejecutar filtro inicial si ya hay un cliente seleccionado
        if (clienteSelect.value) {
            console.log('üîÑ Cliente ya seleccionado, ejecutando filtro inicial');
            filtrarProyectosPorCliente();
        } else {
            // Inicialmente deshabilitar el select de proyectos si no hay cliente
            proyectoSelect.disabled = true;
            console.log('‚úÖ Select de proyectos deshabilitado inicialmente (sin cliente)');
        }
    }
    
    // ===== C√ÅLCULO DE FACTURA =====
    // Definir variables globales
    const montoSubtotalInput = document.getElementById('id_monto_subtotal');
    const porcentajeItbmsSelect = document.getElementById('id_porcentaje_itbms');
    const montoIvaInput = document.getElementById('id_monto_iva');
    const montoTotalInput = document.getElementById('id_monto_total');
    
    console.log('üîç Elementos encontrados:');
    console.log('  - Subtotal:', montoSubtotalInput ? '‚úÖ' : '‚ùå');
    console.log('  - Porcentaje ITBMS:', porcentajeItbmsSelect ? '‚úÖ' : '‚ùå');
    console.log('  - Monto IVA:', montoIvaInput ? '‚úÖ' : '‚ùå');
    console.log('  - Monto Total:', montoTotalInput ? '‚úÖ' : '‚ùå');
    
    // Funci√≥n de c√°lculo
    function calcularFactura() {
        console.log('üîÑ Funci√≥n calcularFactura ejecutada');
        
        if (!montoSubtotalInput || !porcentajeItbmsSelect || !montoIvaInput || !montoTotalInput) {
            console.log('‚ùå No se encontraron todos los campos necesarios');
            return;
        }
        
        const subtotal = parseFloat(montoSubtotalInput.value) || 0;
        const porcentajeItbms = parseFloat(porcentajeItbmsSelect.value) || 0;
        
        console.log('üí∞ Subtotal:', subtotal);
        console.log('üìä Porcentaje ITBMS:', porcentajeItbms + '%');
        
        if (subtotal > 0) {
            // Calcular ITBMS seg√∫n el porcentaje seleccionado
            const itbms = subtotal * (porcentajeItbms / 100);
            const total = subtotal + itbms;
            
            console.log('üßæ ITBMS calculado:', itbms);
            console.log('üíµ Total calculado:', total);
            
            // Actualizar campos
            montoIvaInput.value = itbms.toFixed(2);
            montoTotalInput.value = total.toFixed(2);
            
            console.log('‚úÖ Campos actualizados');
        } else {
            // Limpiar campos si no hay subtotal
            montoIvaInput.value = '0.00';
            montoTotalInput.value = '0.00';
            console.log('üßπ Campos limpiados');
        }
    }
    
    // Agregar event listeners
    if (montoSubtotalInput) {
        montoSubtotalInput.addEventListener('input', calcularFactura);
        montoSubtotalInput.addEventListener('change', calcularFactura);
        montoSubtotalInput.addEventListener('keyup', calcularFactura);
        console.log('‚úÖ Event listeners agregados al campo subtotal');
    }
    
    if (porcentajeItbmsSelect) {
        porcentajeItbmsSelect.addEventListener('change', calcularFactura);
        console.log('‚úÖ Event listeners agregados al campo porcentaje ITBMS');
    }
    
    // Funci√≥n para actualizar subproyectos cuando cambia el proyecto
    // Hacerla global para que pueda ser llamada desde el atributo onchange del widget
    window.actualizarSubproyectosFactura = function() {
        // Usar el mismo select de proyecto que se usa en el filtro
        const proyectoSelect = document.getElementById('id_proyecto') || document.getElementById('id_proyecto_factura');
        const subproyectoSelect = document.getElementById('id_subproyecto_factura');
        const subproyectoContainer = document.getElementById('subproyecto-container-factura');
        
        if (!proyectoSelect || !subproyectoSelect || !subproyectoContainer) {
            return;
        }
        
        const proyectoId = proyectoSelect.value;
        
        // Limpiar opciones actuales
        subproyectoSelect.innerHTML = '<option value="">Seleccionar subproyecto (opcional)</option>';
        
        // Ocultar contenedor si no hay proyecto seleccionado
        if (!proyectoId) {
            subproyectoContainer.style.display = 'none';
            return;
        }
        
        // Hacer petici√≥n AJAX para obtener subproyectos
        fetch(`/api/proyectos/${proyectoId}/subproyectos/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.subproyectos && data.subproyectos.length > 0) {
                // Agregar subproyectos al selector
                data.subproyectos.forEach(subproyecto => {
                    const option = document.createElement('option');
                    option.value = subproyecto.id;
                    option.textContent = subproyecto.nombre + (subproyecto.codigo ? ` (${subproyecto.codigo})` : '');
                    subproyectoSelect.appendChild(option);
                });
                // Mostrar el contenedor de subproyectos
                subproyectoContainer.style.display = 'block';
            } else {
                // Ocultar si no hay subproyectos
                subproyectoContainer.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error al cargar subproyectos:', error);
            subproyectoContainer.style.display = 'none';
        });
    };;
    
    // Funci√≥n auxiliar para obtener cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Agregar event listener al selector de proyecto para subproyectos
    // Usar el mismo select que se usa en el filtro de proyectos por cliente
    if (proyectoSelect) {
        proyectoSelect.addEventListener('change', function() {
            // Actualizar subproyectos cuando cambia el proyecto
            actualizarSubproyectosFactura();
        });
        // Cargar subproyectos si ya hay un proyecto seleccionado
        if (proyectoSelect.value) {
            actualizarSubproyectosFactura();
        }
    }
    
    // Establecer fecha de emisi√≥n por defecto
    const fechaEmisionInput = document.getElementById('id_fecha_emision');
    if (fechaEmisionInput) {
        const today = new Date().toISOString().split('T')[0];
        fechaEmisionInput.value = today;
    }
    
    // Establecer fecha de vencimiento por defecto (30 d√≠as despu√©s)
    const fechaVencimientoInput = document.getElementById('id_fecha_vencimiento');
    if (fechaVencimientoInput) {
        const today = new Date();
        const futureDate = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 d√≠as despu√©s
        fechaVencimientoInput.value = futureDate.toISOString().split('T')[0];
    }
    
    console.log('‚úÖ Factura form inicializado correctamente');
    
    // Vista previa de comprobante
    const comprobanteField = document.getElementById('id_comprobante');
    const comprobantePreview = document.getElementById('comprobantePreview');
    const previewImage = document.getElementById('previewComprobanteImage');
    const previewIcon = document.getElementById('previewComprobanteIcon');
    const previewFileName = document.getElementById('previewComprobanteFileName');
    const previewFileSize = document.getElementById('previewComprobanteFileSize');
    const previewFileType = document.getElementById('previewComprobanteFileType');
    
    if (comprobanteField) {
        comprobanteField.addEventListener('change', function() {
            handleComprobantePreview(this);
        });
    }
    
    function handleComprobantePreview(input) {
        const file = input.files[0];
        if (file) {
            // Validar tama√±o (50MB)
            const maxSize = 50 * 1024 * 1024;
            const clearBtn = document.getElementById('clear-comprobante-btn');
            if (file.size > maxSize) {
                alert('El archivo no puede ser mayor a 50MB');
                input.value = '';
                comprobantePreview.style.display = 'none';
                if (clearBtn) clearBtn.style.display = 'none';
                return;
            }
            
            // Validar tipo de archivo
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!allowedTypes.includes(file.type)) {
                alert('Solo se permiten archivos PDF, JPG o PNG');
                input.value = '';
                comprobantePreview.style.display = 'none';
                if (clearBtn) clearBtn.style.display = 'none';
                return;
            }
            
            // Mostrar informaci√≥n del archivo
            previewFileName.textContent = file.name;
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            previewFileSize.textContent = `Tama√±o: ${fileSizeMB} MB`;
            previewFileType.textContent = `Tipo: ${file.type || 'Desconocido'}`;
            
            // Si es una imagen, mostrar preview
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    previewIcon.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                // Si es PDF, mostrar icono
                previewImage.style.display = 'none';
                previewIcon.style.display = 'flex';
                // Cambiar icono seg√∫n el tipo
                const iconElement = previewIcon.querySelector('i');
                if (file.type === 'application/pdf') {
                    iconElement.className = 'fas fa-file-pdf';
                    iconElement.style.color = '#dc3545';
                }
            }
            
            comprobantePreview.style.display = 'block';
            // Mostrar bot√≥n de eliminar
            if (clearBtn) clearBtn.style.display = 'block';
        } else {
            comprobantePreview.style.display = 'none';
            // Ocultar bot√≥n de eliminar
            const clearBtn = document.getElementById('clear-comprobante-btn');
            if (clearBtn) clearBtn.style.display = 'none';
        }
    }
    
    // Funci√≥n para remover preview
    window.removeComprobantePreview = function() {
        clearComprobanteFile();
    }
    
    // Funci√≥n para limpiar el campo de archivo
    function clearComprobanteFile() {
        const comprobanteField = document.getElementById('id_comprobante');
        const clearBtn = document.getElementById('clear-comprobante-btn');
        
        if (comprobanteField) {
            comprobanteField.value = '';
            // Tambi√©n necesitamos resetear el input file (crear uno nuevo)
            const newInput = comprobanteField.cloneNode(true);
            comprobanteField.parentNode.replaceChild(newInput, comprobanteField);
            // Reasignar el event listener
            const newField = document.getElementById('id_comprobante');
            if (newField) {
                newField.addEventListener('change', function() {
                    handleComprobantePreview(this);
                });
            }
        }
        
        if (comprobantePreview) comprobantePreview.style.display = 'none';
        if (previewImage) {
            previewImage.src = '';
            previewImage.style.display = 'none';
        }
        if (previewIcon) previewIcon.style.display = 'flex';
        if (previewFileName) previewFileName.textContent = '';
        if (previewFileSize) previewFileSize.textContent = '';
        if (previewFileType) previewFileType.textContent = '';
        if (clearBtn) clearBtn.style.display = 'none';
    }
});
</script>
{% endblock %}

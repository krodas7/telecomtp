{% extends "base.html" %}
{% load custom_filters %}

{% block title %}Configurar Planilla - {{ proyecto.nombre }}{% endblock %}

{% block extra_css %}
<style>
    .config-container {
        max-width: 900px;
        margin: 2rem auto;
    }
    
    .config-card {
        background: white;
        border-radius: 20px;
        padding: 2.5rem;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        margin-bottom: 2rem;
    }
    
    .config-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        text-align: center;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
    }
    
    .section-title {
        color: #667eea;
        font-weight: 700;
        font-size: 1.3rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 3px solid #667eea;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .help-text {
        font-size: 0.85rem;
        color: #6c757d;
        font-style: italic;
    }
    
    .preview-box {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1.5rem;
        border-radius: 15px;
        border: 2px solid #dee2e6;
        margin-top: 1.5rem;
    }
    
    .preview-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px dashed #dee2e6;
    }
    
    .preview-item:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 1.1rem;
        color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="config-container">
    <div class="config-header">
        <h2>
            <i class="fas fa-cog me-2"></i>Configuración de Planilla
        </h2>
        <p class="mb-0 mt-2">{{ proyecto.nombre }}</p>
    </div>
    
    <div class="config-card">
        <form method="POST">
            {% csrf_token %}
            
            <!-- Retenciones -->
            <div class="mb-4">
                <h4 class="section-title">
                    <i class="fas fa-minus-circle me-2"></i>Retenciones
                </h4>
                
                <div class="form-check mb-3">
                    {{ form.aplicar_retenciones }}
                    <label class="form-check-label" for="{{ form.aplicar_retenciones.id_for_label }}">
                        Aplicar retenciones automáticamente
                    </label>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.retencion_seguro_social.id_for_label }}" class="form-label">
                            <i class="fas fa-shield-alt me-1"></i>{{ form.retencion_seguro_social.label }}
                        </label>
                        {{ form.retencion_seguro_social }}
                        <small class="help-text">Monto fijo mensual de Seguro Social (CSS)</small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.retencion_seguro_educativo.id_for_label }}" class="form-label">
                            <i class="fas fa-graduation-cap me-1"></i>{{ form.retencion_seguro_educativo.label }}
                        </label>
                        {{ form.retencion_seguro_educativo }}
                        <small class="help-text">Monto fijo mensual de Seguro Educativo</small>
                    </div>
                </div>
                
                <div class="preview-box">
                    <strong><i class="fas fa-calculator me-2"></i>Total Retenciones Mensuales:</strong>
                    <span class="text-danger" id="totalRetenciones">${{ configuracion.total_retenciones_monto|floatformat:2 }}</span>
                </div>
            </div>
            
            <!-- Bonos -->
            <div class="mb-4">
                <h4 class="section-title">
                    <i class="fas fa-plus-circle me-2"></i>Bonos
                </h4>
                
                <div class="form-check mb-3">
                    {{ form.aplicar_bonos }}
                    <label class="form-check-label" for="{{ form.aplicar_bonos.id_for_label }}">
                        Aplicar bonos automáticamente
                    </label>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.bono_general.id_for_label }}" class="form-label">
                            <i class="fas fa-gift me-1"></i>{{ form.bono_general.label }}
                        </label>
                        {{ form.bono_general }}
                        <small class="help-text">Monto fijo mensual ($) - Incluye alimentación, transporte, etc.</small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.bono_produccion.id_for_label }}" class="form-label">
                            <i class="fas fa-chart-line me-1"></i>{{ form.bono_produccion.label }}
                        </label>
                        {{ form.bono_produccion }}
                        <small class="help-text">% sobre el salario base - Incentivo por productividad</small>
                    </div>
                </div>
            </div>
            
            <!-- Asignación de Bonos por Colaborador -->
            {% if colaboradores %}
            <div class="mb-4">
                <h4 class="section-title">
                    <i class="fas fa-users-cog me-2"></i>Asignación de Bonos por Colaborador
                </h4>
                <p class="text-muted mb-3" style="font-size: 0.9rem;">
                    <i class="fas fa-info-circle me-1"></i>
                    Las retenciones se aplican a TODOS los colaboradores. Los bonos pueden ser selectivos.
                </p>
                
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead style="background: #f8f9fa;">
                            <tr>
                                <th style="width: 40%;">Colaborador</th>
                                <th style="text-align: center; width: 30%;">
                                    <i class="fas fa-gift me-1"></i>Bono General
                                </th>
                                <th style="text-align: center; width: 30%;">
                                    <i class="fas fa-chart-line me-1"></i>Bono Producción
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for colaborador in colaboradores %}
                            <tr>
                                <td style="padding: 1rem;">
                                    <strong>{{ colaborador.nombre }}</strong>
                                    <br><small class="text-muted">Salario: ${{ colaborador.salario|floatformat:2 }}</small>
                                </td>
                                <td style="text-align: center; padding: 1rem;">
                                    <div class="form-check d-inline-block">
                                        <input 
                                            type="checkbox" 
                                            class="form-check-input" 
                                            name="bono_general_{{ colaborador.id }}" 
                                            id="bono_general_{{ colaborador.id }}"
                                            {% if colaborador.aplica_bono_general %}checked{% endif %}>
                                        <label class="form-check-label" for="bono_general_{{ colaborador.id }}">
                                            Aplicar
                                        </label>
                                    </div>
                                </td>
                                <td style="text-align: center; padding: 1rem;">
                                    <div class="form-check d-inline-block">
                                        <input 
                                            type="checkbox" 
                                            class="form-check-input" 
                                            name="bono_produccion_{{ colaborador.id }}" 
                                            id="bono_produccion_{{ colaborador.id }}"
                                            {% if colaborador.aplica_bono_produccion %}checked{% endif %}>
                                        <label class="form-check-label" for="bono_produccion_{{ colaborador.id }}">
                                            Aplicar
                                        </label>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-shield-alt me-2"></i>
                    <strong>Nota:</strong> Las retenciones (Seguro Social y Seguro Educativo) se aplican automáticamente a TODOS los colaboradores sin excepción.
                </div>
            </div>
            {% endif %}
            
            <!-- Botones -->
            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'planilla_proyecto' proyecto.id %}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-arrow-left me-2"></i>Cancelar
                </a>
                <button type="submit" class="btn btn-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                    <i class="fas fa-save me-2"></i>Guardar Configuración
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Calcular total de retenciones dinámicamente
    document.addEventListener('DOMContentLoaded', function() {
        const retencionSS = document.getElementById('{{ form.retencion_seguro_social.id_for_label }}');
        const retencionSE = document.getElementById('{{ form.retencion_seguro_educativo.id_for_label }}');
        
        function actualizarTotal() {
            const total = (parseFloat(retencionSS.value) || 0) + 
                         (parseFloat(retencionSE.value) || 0);
            document.getElementById('totalRetenciones').textContent = '$' + total.toFixed(2);
        }
        
        [retencionSS, retencionSE].forEach(input => {
            if (input) input.addEventListener('input', actualizarTotal);
        });
    });
</script>
{% endblock %}


{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Login - Sistema TelecomTP{% endblock %}

{% block content %}
<div class="min-vh-100 d-flex align-items-center justify-content-center login-background">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="card shadow-lg border-0 login-card">
                    <div class="card-header text-center py-4" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; border-radius: 12px 12px 0 0;">
                        <div class="mb-3">
                            <img src="{% static 'images/ISOTIPO-TELECOM-small.png' %}" alt="TelecomTP Isotipo" style="height: 80px; width: auto; margin-bottom: 15px;">
                        </div>
                        <h3 class="mb-0">
                            Sistema TelecomTP
                        </h3>
                        <p class="text-white mb-0" style="opacity: 0.9;">Inicia sesión para continuar</p>
                    </div>
                    <div class="card-body p-4">
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                        
                        <form method="post">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="username" class="form-label">
                                    <i class="fas fa-user me-2" style="color: #1e3a8a;"></i>Usuario
                                </label>
                                <input type="text" class="form-control form-control-lg" id="username" name="username" required>
                            </div>
                            <div class="mb-4">
                                <label for="password" class="form-label">
                                    <i class="fas fa-lock me-2" style="color: #1e3a8a;"></i>Contraseña
                                </label>
                                <input type="password" class="form-control form-control-lg" id="password" name="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg w-100 login-btn">
                                <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión
                            </button>
                        </form>
                    </div>
                    <div class="card-footer text-center py-3" style="background-color: #f8f9fa; border-top: 1px solid #dee2e6;">
                        <small class="text-muted" style="color: #1e3a8a !important;">
                            <i class="fas fa-info-circle me-1" style="color: #fbbf24;"></i>
                            Software desarrollado por: SELITEC. <br>
                            PROPIEDAD DE: TelecomTP
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Banner de PWA -->
<div id="pwa-banner" class="pwa-banner">
    <div class="pwa-banner-content">
        <div class="pwa-banner-icon">
            <i class="fas fa-download"></i>
        </div>
        <div class="pwa-banner-text">
            <h5>¡Instala nuestra app!</h5>
            <p>Accede más rápido desde tu pantalla de inicio</p>
        </div>
        <div class="pwa-banner-actions">
            <button id="pwa-install-btn" class="btn btn-success btn-sm">
                <i class="fas fa-plus me-1"></i>Instalar
            </button>
            <button id="pwa-dismiss-btn" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</div>

<style>
/* RESET GLOBAL - ELIMINAR BORDES BLANCOS */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow-x: hidden;
}

body {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
    min-height: 100vh;
    margin: 0;
    padding: 0;
}

.login-background {
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
    min-height: 100vh;
    width: 100vw;
    height: 100vh;
    margin: 0;
    padding: 0;
}

.login-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        radial-gradient(circle at 20% 80%, rgba(251, 191, 36, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(251, 191, 36, 0.1) 0%, transparent 50%),
        linear-gradient(45deg, transparent 48%, rgba(251, 191, 36, 0.05) 50%, transparent 52%),
        linear-gradient(-45deg, transparent 48%, rgba(251, 191, 36, 0.05) 50%, transparent 52%);
    background-size: 300px 300px, 400px 400px, 60px 60px, 60px 60px;
    background-position: 0 0, 0 0, 0 0, 0 0;
    animation: backgroundMove 20s ease-in-out infinite;
    z-index: 1;
}

@keyframes backgroundMove {
    0%, 100% { transform: translate(0, 0); }
    25% { transform: translate(-10px, -10px); }
    50% { transform: translate(10px, 10px); }
    75% { transform: translate(-5px, 5px); }
}

/* Elementos decorativos de construcción */
.login-background::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        radial-gradient(circle at 10% 90%, rgba(251, 191, 36, 0.15) 0%, transparent 30%),
        radial-gradient(circle at 90% 10%, rgba(251, 191, 36, 0.15) 0%, transparent 30%);
    background-size: 200px 200px, 250px 250px;
    background-position: 0 0, 0 0;
    animation: float 15s ease-in-out infinite;
    z-index: 1;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    33% { transform: translateY(-20px) rotate(1deg); }
    66% { transform: translateY(10px) rotate(-1deg); }
}

.login-background .container {
    position: relative;
    z-index: 2;
}

.login-card {
    border-top: 4px solid #fbbf24 !important;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
}

.card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
}

.form-control:focus {
    border-color: #fbbf24;
    box-shadow: 0 0 0 0.2rem rgba(251, 191, 36, 0.25);
}

.login-btn {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%) !important;
    border: none !important;
    color: white !important;
    font-weight: 600;
    padding: 12px 24px;
    transition: all 0.3s ease;
}

.login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(30, 58, 138, 0.4);
    background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%) !important;
}

.login-btn:active {
    transform: translateY(0);
}

/* Asegurar que el botón sea visible */
.btn-primary {
    background-color: #1e3a8a !important;
    border-color: #1e3a8a !important;
}

.btn-primary:hover {
    background-color: #1e40af !important;
    border-color: #1e40af !important;
}

/* Mejorar la visibilidad de los campos de formulario */
.form-control {
    border: 2px solid #e5e7eb;
    transition: all 0.3s ease;
}

.form-control:focus {
    border-color: #1e3a8a;
    box-shadow: 0 0 0 0.2rem rgba(30, 58, 138, 0.25);
}

/* Asegurar que el fondo cubra toda la pantalla */
body, html {
    height: 100%;
    margin: 0;
    padding: 0;
}

.min-vh-100 {
    min-height: 100vh !important;
}

/* Ocultar sidebar y navegación superior en login */
.sidebar, .top-nav {
    display: none !important;
}

/* Asegurar que el contenido principal ocupe todo el ancho en login */
.main-content {
    margin-left: 0 !important;
    width: 100% !important;
    padding: 0 !important;
}

/* Estilos del banner PWA */
.pwa-banner {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    color: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    z-index: 9999;
    max-width: 400px;
    width: 90%;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    border: 2px solid #fbbf24;
}

.pwa-banner.show {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
}

.pwa-banner-content {
    display: flex;
    align-items: center;
    padding: 15px;
    gap: 12px;
}

.pwa-banner-icon {
    font-size: 24px;
    color: #fbbf24;
    flex-shrink: 0;
}

.pwa-banner-text {
    flex: 1;
}

.pwa-banner-text h5 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: white;
}

.pwa-banner-text p {
    margin: 0;
    font-size: 12px;
    opacity: 0.9;
    color: #e5e7eb;
}

.pwa-banner-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
}

.pwa-banner-actions .btn {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.pwa-banner-actions .btn:hover {
    transform: translateY(-1px);
}

/* Responsive para móviles */
@media (max-width: 480px) {
    .pwa-banner {
        top: 10px;
        width: 95%;
        max-width: none;
    }
    
    .pwa-banner-content {
        padding: 12px;
        gap: 10px;
    }
    
    .pwa-banner-text h5 {
        font-size: 14px;
    }
    
    .pwa-banner-text p {
        font-size: 11px;
    }
    
    .pwa-banner-actions .btn {
        padding: 5px 10px;
        font-size: 11px;
    }
}
</style>

<script>
// Banner de PWA
document.addEventListener('DOMContentLoaded', function() {
    const pwaBanner = document.getElementById('pwa-banner');
    const installBtn = document.getElementById('pwa-install-btn');
    const dismissBtn = document.getElementById('pwa-dismiss-btn');
    let deferredPrompt;
    let bannerShown = false;
    let installAvailable = false;

    // Respetar una pausa si el usuario cerró el banner recientemente (3 días)
    const dismissedUntil = parseInt(localStorage.getItem('pwaBannerDismissedUntil') || '0', 10);
    if (Date.now() < dismissedUntil) {
        return;
    }

    // Escuchar el evento beforeinstallprompt
    window.addEventListener('beforeinstallprompt', function(e) {
        e.preventDefault();
        deferredPrompt = e;
        installAvailable = true;
        // Mostrar el banner después de 1.5s
        setTimeout(() => {
            if (!bannerShown) {
                showPwaBanner();
            }
        }, 1500);
    });

    // Fallback: si el evento no llega en 5s, mostrar el banner igualmente con instrucciones
    setTimeout(() => {
        if (!bannerShown) {
            showPwaBanner();
        }
    }, 5000);

    function showPwaBanner() {
        bannerShown = true;
        pwaBanner.classList.add('show');
        // Ocultar automáticamente después de 10 segundos
        setTimeout(() => {
            hidePwaBanner();
        }, 10000);
    }

    function hidePwaBanner() {
        pwaBanner.classList.remove('show');
    }

    // Botón de instalar
    installBtn.addEventListener('click', function() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(function(choiceResult) {
                if (choiceResult.outcome === 'accepted') {
                    localStorage.setItem('pwaBannerDismissedUntil', String(Date.now() + 1000 * 60 * 60 * 24 * 30)); // 30 días
                }
                deferredPrompt = null;
                hidePwaBanner();
            });
        } else {
            // Sin evento disponible: dar instrucciones manuales
            alert('Para instalar: abre el menú del navegador y selecciona "Añadir a pantalla de inicio".');
            localStorage.setItem('pwaBannerDismissedUntil', String(Date.now() + 1000 * 60 * 60 * 24 * 3)); // 3 días
            hidePwaBanner();
        }
    });

    // Botón de cerrar
    dismissBtn.addEventListener('click', function() {
        localStorage.setItem('pwaBannerDismissedUntil', String(Date.now() + 1000 * 60 * 60 * 24 * 3)); // 3 días
        hidePwaBanner();
    });

    // Verificar si la PWA ya está instalada
    window.addEventListener('appinstalled', function() {
        localStorage.setItem('pwaBannerDismissedUntil', String(Date.now() + 1000 * 60 * 60 * 24 * 365)); // 1 año
        hidePwaBanner();
    });
});
</script>

{% endblock %}
